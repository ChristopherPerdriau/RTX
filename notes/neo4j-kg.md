# Build, test, and deploy the Neo4j KG for RTX

## Starting EC2 instance
To start or stop an EC2 instance do the following:
* Follow this [link](http://ec2startstop.saramsey.org/cgi-bin/manage-instances-cgi.py)
* Enter the username and password when prompted
* Look to see that the ec2 instance is not already in the state you want it to be in. You will want to start/stop the instance named 'ramseyst-rtxsteve-8xlarge'
* Check the bubble next to the instance
* Check start (or stop) instance
* Enter the instance specific passcode
* Click on the submit button

**NOTE:** If you do not have the username or password please email Finn or message him on the isb-ncats slack channel.

## Starting docker containers
After starting up the ec2 instance you will need to start up the docker containers you wish to use. First connect to the ec2 instance by entering the following into the terminal:
```
ssh -A ubuntu@rtxsteve.saramsey.org
```
Once you are connected to the ec2 instance, enter the following commands
* ```sudo docker start rtxsteve``` (This starts up the rtxsteve container)
* ```sudo docker exec -it rtxsteve bash``` (Enter the docker container)
* ```service neo4j start``` (Starts up the neo4j service)

To update the git repo, open a shell in the “rtxdev” container (as described above) and then run the following commands:
```
su - rt
cd /mnt/data/orangeboard/RTX
git pull origin master
```
Change current directory to where the ``run_build_master_kg.sh`` is located and execute it:
```
cd /mnt/data/orangeboard/RTX/code/reasoningtool/kg-construction
./run_build_master_kg.sh
```
***Note: This process can take up to 60 hours***

A quick way to check if the kg-build is still running is to see if a python process is running in the os
```
ps ax grep | python3
```

The output and error logs are generated by the run_build_master_kg.sh script. You can view them by entering ```cat stdout.log``` and ```cat stderr.log``` in the same directory.

## Checking the neo4j database
Once the kg-build is complete, you will want to view the newly built knowledge graph [here]( http://rtxsteve.saramsey.org:7474/browser/) with the usual username and password to verify that everything is in order.

## Testing the neo4j database
Running the test cases for checking the neo4j database
```
cd /mnt/data/orangeboard/RTX/code/reasoningtool/kg-construction/tests
python3 KGTests.py
```

## Exporting the neo4j database
Running the following commands to backup the neo4j database file and transfer the zip file to 'rtxkgdump.saramsey.org' instance
```
sh /home/ubuntu/copy-kg-to-s3.sh
sh /home/ubuntu/run-backup-neo4j.sh
```

## Stopping docker containers
Once you have verified that the kg-build was successful, you will need to stop the neo4j instance, and the docker container that were in use with the following commands:
```
service neo4j stop
exit
sudo docker stop rtxsteve
exit
```

## Loading the neo4j database
Download the .tar.gz file from 'rtxkgdump.saramsey.org' instance, then unzip it to a dump file and load the dump file to neo4j database
```
tar -zxvf xxxx.tar.gz
neo4j-admin load --from=[absolute directory]/xxxx.dump --database=graph --force
```

